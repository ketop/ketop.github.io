---
title: "交换机网关"
date: 2018-08-16T19:48:06+08:00
tags: ['tcp/ip', '网络']
draft: false
---
TCP是面向连接的协议，它提供持续可交付的可靠连接。充分实现了数据传输时的各种控制功能，可以进行丢包时的重发控制，还可以对次序乱掉的分包进行顺序控制。TCP只有在确认通信对端存在时才会发送数据，从而可以控制通信流量的浪费。

- 通过序列号与确认应答提高可靠性。 当发送端的数据到达主机时，接收端主机会返回一个已收到消息的通知，该消息称为*确认应答(ACK)*。
> 如果收到了ACK，表示数据已经成功送达。当没有收到ACK时，有可能是数据丢失，或者ACK在返回时丢失，此外还有可能是因为其他原因而延迟到达。 这时，主机可能会重发数据。这种重发机制能保证数据不丢失。但是，如果数据已经到达，只是ACK没有接收到，则重发会给接收端带来负担。它需要一种机制，使接收端识别是否已经收到数据，又能判断是否需要接收。

>这些需要的功能可以通过序列号实现。序列号是按顺序给发送数据的每个字节都标上号码的编号。接收端查询接收数据TCP首部的序列号和数据长度，将自己下一步应该接收的序号作为确认应答返送回去。这样通过序列号和确认应答号，TCP可以实现可靠传输。

- 重发超时的确定。 重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔。如果超过了指定时间仍未收到确认应答，发送端将进行数据重发。 TCP在每次发包时，会计算往返时间及其偏差。
> 往返时间，指报文段的往返时间。 Round Trip Time, RTT。

> 偏差， RTT时间波动的值、方差。有时也称抖动。一般设置的重发超时 时间以0.5s为单位，是其整数倍。偏差的最小值也是0.5,因此最小的重发时间为1s。初始通信的重发超时时间为6s。如果重发后仍没有ACK，则进行再次发送，此时，等待确认应答时间将会以2倍、4倍的指数函数延长。在达到一定重发次数后，如果仍未回应，则会判断为网络对端主机发生了异常，强制关闭连接，并通知应用程序异常强行终止。

- 连接管理

(三次握手)
1. 客户端发送连接请求SYN
2. 服务端发送ACK，以及SYN允许
3. 客户端对服务端发送ACK表示成功连接

(断开连接)
1. 客户端发送FIN，请求切断连接
2. 服务端发送FIN的ACK应答
3. 服务端发送FIN给客户端
4. 客户端向服务端发送ACK

综上知，一个连接的建立和断开的正常过程至少需要7个包才能完成。

- TCP以段为单位发送数据
在建立TCP连接的同时，也可以确定发送数据包的单位。称为MSS(Maximum Segment Size).最理想情况下，最大消息长度正好是IP中不会被分片处理的最大数据长度。

TCP在传送大量数据时，是以MSS的大小将数据进行分割发送。进行重发时以MSS为单位。

MSS是在三次握手的时候，在两端主机之间被计算得出。两端主机在发出建立连接的请求时，会在TCP首部中写入MSS选项，告诉对方的接口能够适应的MSS的大小。然后在传输数据时选择二者之间较小的一个。

- 利用窗口控制提高速度。每发一个段进行一次确认应答，然后再发送下一段，这种方式的缺点是，包往返的时间越长，网络的吞吐量会越差。为解决这个问题，TCP引入窗口概念。
> 确认应答不再每段返回一次，而是以更大的单位进行确认，这样转发时间将会被大幅度地缩短。
>窗口大小就是指无需等待确认应答而可以继续发送数据的最大值。该机制的实现使用了大量的缓冲区，通过多个段同时进行确认应答的功能。

> 如果没有达到数据窗口最大值就有确认应答返回，则说明存在数据在传输中丢失的情况。这种情况将进行重发。为此，发送端主机在等到确认应答返回之前，必须在缓冲区中保留这部分数据。

- 窗口控制与重发控制。
当数据已经被接收，但是没有收到ACK时，可以通过之后的ACK来确认数据已经收到。但是当某些数据没有被接收而导致的ACK没有接收时，会等待，如果再出现连续3次重复接收这个ACK时，会重发该段。这种机制比起超时机制可以提供更加快速的重发服务。

- 流控制。 发送端控制时，应该考虑接收端的情况，这样可以避免触发重发机制。TCP提供一种机制可以发送端根据接收端的实际接收能力控制发送的数据量。具体的操作是， 接收端主机想发送端主机通知自己可以接收的数据大小，于是发送端会发送不超过这个限度的数据。该大小限制就被称为串口大小。窗口大小的值由接收端主机来决定。
>TCP首部中，专门有这个字段来通知窗口大小。接收主机将自己可以接收的缓冲区大小放入这个字段中通知给发送端。这个字段越大，说明网络的吞吐量越高。不过当接收端这个缓冲区一旦面临数据溢出时，窗口大小的值会随之被设置为一个更小的值通知给发送端，从而控制数据发送量。这样就形成了一个完整的TCP流控制。

当接收端缓冲区满，不得不停止接收数据。之后，在收到窗口更新通知后通信才得继续运行。如果窗的更新通知在传送中丢失，可能导致无法继续通信。为避免此类问题的发生，发送端主机会时不时的发送一个叫窗口探测的数据段，此数据段仅含一个字节以获取最新的窗口大小信息。


- 拥塞控制

